name: çµŒæ¸ˆå­¦ä»®èª¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ä»˜ãï¼‰

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = JST 09:00
  
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼: GitHub UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°'
        required: false
        default: 'false'
        type: boolean
      update_feedback_only:
        description: 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿æ›´æ–°'
        required: false
        default: 'false'
        type: boolean
  
  # ãƒ—ãƒƒã‚·ãƒ¥ãƒˆãƒªã‚¬ãƒ¼: masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
  push:
    branches: [ master ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
  
  # Issueãƒˆãƒªã‚¬ãƒ¼: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯IssueãŒä½œæˆã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
  issues:
    types: [opened, edited]

jobs:
  generate-hypotheses:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_feedback_only == 'false' || github.event.inputs.update_feedback_only == '' }}
    
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pages: write     # GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      id-token: write  # OIDC tokenæ¨©é™
      issues: read     # Issueã®èª­ã¿å–ã‚Šæ¨©é™
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: çµŒæ¸ˆå­¦ä»®èª¬ã®ç”Ÿæˆ
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        cd scripts
        python generate_hypotheses.py
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
        if [ -f "hypotheses.json" ]; then
          echo "âœ… ä»®èª¬ç”Ÿæˆå®Œäº†"
          cat hypotheses.json | jq '.total_hypotheses' || echo "JQ not available"
        else
          echo "âŒ ä»®èª¬ç”Ÿæˆå¤±æ•—"
          exit 1
        fi
    
    - name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
      run: |
        cd scripts
        python feedback_manager.py
        echo "ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"
    
    - name: ç”Ÿæˆçµæœã‚’Webã‚µã‚¤ãƒˆç”¨ã«é…ç½®
      run: |
        # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        mkdir -p public/data
        cp scripts/hypotheses.json public/data/
        
        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if [ -f "public/data/feedback_summary.json" ]; then
          echo "ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’é…ç½®"
        fi
        
        # æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¨˜éŒ²
        echo "{\"last_updated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"includes_feedback\": true}" > public/data/metadata.json
        
        echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®å®Œäº†"
        ls -la public/data/
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        npm run build
        echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰å®Œäº†"
        ls -la dist/
    
    - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦æº–å‚™
      run: |
        # GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ä½œæˆ
        tar -czf github-pages.tar.gz -C dist .
    
    - name: GitHub Pagesã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-pages-artifact@v2
      with:
        path: dist
        # venvãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤å¤–
        exclude: |
          economics_api/venv/
    
    - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          git add public/data/
          git add scripts/hypothesis_generator.log || true
          git commit -m "ğŸ¤– çµŒæ¸ˆå­¦ä»®èª¬ã‚’è‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "ğŸ“ å¤‰æ›´ãªã— - ãƒ—ãƒƒã‚·ãƒ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
    
    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… çµŒæ¸ˆå­¦ä»®èª¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"
          echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        else
          echo "âŒ å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        fi
    
    - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hypothesis-generation-logs
        path: |
          scripts/hypothesis_generator.log
          scripts/hypotheses.json
          public/data/feedback_summary.json
        retention-days: 30

  # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã¿æ›´æ–°ã™ã‚‹ã‚¸ãƒ§ãƒ–
  update-feedback:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.update_feedback_only == 'true' || github.event_name == 'issues' }}
    
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pages: write     # GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      id-token: write  # OIDC tokenæ¨©é™
      issues: read     # Issueã®èª­ã¿å–ã‚Šæ¨©é™
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
      run: |
        cd scripts
        python feedback_manager.py
        echo "ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"
    
    - name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®é…ç½®
      run: |
        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if [ -f "public/data/feedback_summary.json" ]; then
          echo "ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª"
          cat public/data/feedback_summary.json | head -20
        fi
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        echo "{\"last_updated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"feedback_only_update\": true}" > public/data/feedback_metadata.json
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        npm run build
        echo "ğŸ—ï¸ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ›´æ–°ãƒ“ãƒ«ãƒ‰å®Œäº†"
    
    - name: GitHub Pagesã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-pages-artifact@v2
      with:
        path: dist
    
    - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          git add public/data/
          git commit -m "ğŸ“Š ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "ğŸ“¤ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ›´æ–°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "ğŸ“ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«å¤‰æ›´ãªã—"
        fi

  # GitHub Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-pages:
    needs: [generate-hypotheses, update-feedback]
    if: always() && (needs.generate-hypotheses.result == 'success' || needs.update-feedback.result == 'success')
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      id: deployment
      uses: actions/deploy-pages@v2

  # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify-feedback:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'feedback') }}
    
    permissions:
      issues: write
    
    steps:
    - name: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å—ä¿¡é€šçŸ¥
      uses: actions/github-script@v7
      with:
        script: |
          const issueNumber = context.issue.number;
          const issueTitle = context.payload.issue.title;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: `ğŸ™ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯è‡ªå‹•çš„ã«å‡¦ç†ã•ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ ã«åæ˜ ã•ã‚Œã¾ã™ã€‚

- **å‡¦ç†çŠ¶æ³**: å—ä¿¡å®Œäº† âœ…
- **åæ˜ äºˆå®š**: æ¬¡å›ã®è‡ªå‹•æ›´æ–°æ™‚ï¼ˆæ¯æ—¥åˆå‰9æ™‚ï¼‰
- **ç¢ºèªæ–¹æ³•**: [Webã‚µã‚¤ãƒˆ](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}) ã§ç¢ºèªã§ãã¾ã™

ã”å”åŠ›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼`
          });
          
          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆã¾ã ãªã„å ´åˆï¼‰
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            labels: ['feedback', 'processed']
          });





