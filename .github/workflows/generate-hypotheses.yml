name: çµŒæ¸ˆå­¦ä»®èª¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = JST 09:00
  
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼: GitHub UIã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°ãƒ•ãƒ©ã‚°'
        required: false
        default: 'false'
        type: boolean
  
  # ãƒ—ãƒƒã‚·ãƒ¥ãƒˆãƒªã‚¬ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  generate-hypotheses:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      pages: write     # GitHub Pagesã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
      id-token: write  # OIDC tokenæ¨©é™
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
    
    - name: çµŒæ¸ˆå­¦ä»®èª¬ã®ç”Ÿæˆ
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        cd scripts
        python generate_hypotheses.py
        
        # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
        if [ -f "hypotheses.json" ]; then
          echo "âœ… ä»®èª¬ç”Ÿæˆå®Œäº†"
          cat hypotheses.json | jq '.total_hypotheses'
        else
          echo "âŒ ä»®èª¬ç”Ÿæˆå¤±æ•—"
          exit 1
        fi
    
    - name: ç”Ÿæˆçµæœã‚’Webã‚µã‚¤ãƒˆç”¨ã«é…ç½®
      run: |
        # ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        mkdir -p public/data
        cp scripts/hypotheses.json public/data/
        
        # æœ€çµ‚æ›´æ–°æ—¥æ™‚ã‚’è¨˜éŒ²
        echo "{\"last_updated\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > public/data/metadata.json
        
        echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®å®Œäº†"
        ls -la public/data/
    
    - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: npm ci
    
    - name: Reactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      run: |
        npm run build
        echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰å®Œäº†"
        ls -la dist/
    
    - name: GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      uses: actions/deploy-pages@v3
      with:
        artifact_name: github-pages
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -n "$(git status --porcelain)" ]; then
          git add public/data/
          git add scripts/hypothesis_generator.log || true
          git commit -m "ğŸ¤– çµŒæ¸ˆå­¦ä»®èª¬ã‚’è‡ªå‹•ç”Ÿæˆãƒ»æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "ğŸ“¤ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        else
          echo "ğŸ“ å¤‰æ›´ãªã— - ãƒ—ãƒƒã‚·ãƒ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi
    
    - name: å®Ÿè¡Œçµæœã®é€šçŸ¥
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… çµŒæ¸ˆå­¦ä»®èª¬ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ"
          echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        else
          echo "âŒ å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        fi
    
    - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: hypothesis-generation-logs
        path: |
          scripts/hypothesis_generator.log
          scripts/hypotheses.json
        retention-days: 30

  # GitHub Pagesã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-pages:
    needs: generate-hypotheses
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      id: deployment
      uses: actions/deploy-pages@v3

